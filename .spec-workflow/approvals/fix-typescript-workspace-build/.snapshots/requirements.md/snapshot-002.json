{
  "id": "snapshot_1758708106550_evlm3ryyu",
  "approvalId": "approval_1758708050985_fgw6a2zp5",
  "approvalTitle": "Requirements – fix-typescript-workspace-build v0.1.0",
  "version": 2,
  "timestamp": "2025-09-24T10:01:46.550Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\nThe Docker build stage fails during `pnpm build` because TypeScript cannot resolve the\nworkspace package `@moduprompt/types`, cascading into implicit `any` errors and blocking\ncompiler/snippet-store compilation. The spec captures the work needed to restore a clean\nworkspace build, align TypeScript module resolution with the approved steering docs, and\nensure documentation reflects the necessary setup for contributors running Docker Compose.\n\n## Alignment with Product Vision\n- **Product Steering (§Product Pillars – Deterministic Delivery, Governed Snippets)**: restoring\nthe deterministic build pipeline keeps exports and snippet governance reliable across self-hosted\ninstalls.\n- **Technical Steering (§Architecture Overview, Technology Stack)**: TypeScript shared types are\nthe source of truth for client/server contracts; fixing resolution protects the modular architecture\nand offline-first workflows.\n- **Structure Steering (§Repository Layout, Code Organization Principles)**: reinforces shared\ntypes consumption from `packages/types` across packages and keeps Docker deploy assets under\n`deploy/docker` functional.\n\n## Requirements\n\n### Requirement 1 – Workspace packages resolve shared types during builds\n\n**User Story:** As a platform engineer operating ModuPrompt in Docker, I want the workspace\npackages to resolve `@moduprompt/types` during `pnpm build`, so that container builds succeed\nwithout manual intervention.\n\n#### Acceptance Criteria\n\n1. WHEN `pnpm build` runs after `pnpm install --frozen-lockfile --ignore-scripts` on a clean\n   checkout THEN every package SHALL resolve `@moduprompt/types` without TS2307 errors.\n2. IF `docker compose --profile core --env-file .env.local up --build --wait` executes using the\n   provided Dockerfile THEN the build stage SHALL finish without TypeScript compilation failures.\n3. WHEN `pnpm typecheck` executes in CI or locally THEN the workspace SHALL complete without\n   module resolution errors for `@moduprompt/types`.\n\n### Requirement 2 – Third-party module typings are available for the compiler\n\n**User Story:** As a compiler maintainer, I want first-party typings for `sanitize-html`, so that the\ncompiler server module builds without `any`-typed surfaces and parser regressions.\n\n#### Acceptance Criteria\n\n1. WHEN TypeScript compiles `packages/compiler` THEN the import of `sanitize-html` SHALL have\n   concrete typings (either via `@types/sanitize-html` or an internal declaration) eliminating TS7016.\n2. IF the typings rely on a new dependency THEN `pnpm install --frozen-lockfile` SHALL pin and lock\nthe version without breaking existing consumers.\n3. WHEN the compiler’s HTML export utilities run under unit tests THEN no new implicit `any`\n   warnings SHALL appear in `pnpm typecheck`.\n\n### Requirement 3 – Contributor documentation reflects build prerequisites\n\n**User Story:** As a contributor following the Docker quick start, I want the README to call out the\nnecessary steps or troubleshooting to ensure workspace builds succeed, so that I can recover if the\nimage build fails due to type resolution.\n\n#### Acceptance Criteria\n\n1. WHEN a reader follows the Docker quick start in `README.md` THEN the instructions SHALL\n   mention the shared types build dependency or troubleshoot module resolution failures.\n2. IF a manual remediation (e.g., running `pnpm build` locally) is required THEN the README SHALL\n   instruct how to apply it without weakening security (no secrets in commands).\n3. WHEN documentation updates land THEN they SHALL reference the spec ID and remain consistent\n   with steering documents.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: tsconfig changes MUST reside in shared config files (e.g.,\n  `tsconfig.base.json`) to avoid duplicating logic across packages.\n- **Modular Design**: Shared type consumption SHALL continue via workspace package imports;\n  avoid ad-hoc relative paths.\n- **Dependency Management**: Any new type dependency SHALL be added to the owning package\n  with explicit rationale and lockfile update.\n- **Clear Interfaces**: Shared types SHALL remain the contract surface; no leaking of implementation\n  details from compiler/snippet-store internals.\n\n### Performance\n- Build time SHALL remain within existing CI budgets (no more than +10% wall-clock for `pnpm build`).\n- Module resolution changes SHALL not introduce runtime performance regressions.\n\n### Security\n- New dependencies (e.g., typings) MUST be vetted per <security-supply-chain/> with license and\n  advisory checks.\n- Documentation SHALL avoid exposing secrets or insecure defaults beyond dev-only guidance.\n\n### Reliability\n- Build/test commands SHALL remain deterministic per <determinism-and-reproducibility/>; ensure\n  no caching side effects break reproducibility.\n\n### Usability\n- README guidance SHALL be actionable and minimal, reducing onboarding friction for contributors.\n",
  "fileStats": {
    "size": 4986,
    "lines": 94,
    "lastModified": "2025-09-24T10:00:45.586Z"
  },
  "comments": []
}